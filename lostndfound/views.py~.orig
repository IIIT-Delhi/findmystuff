from django.contrib.auth.decorators import login_required
from django.template import RequestContext
from django.shortcuts import render_to_response, redirect
from django.http import HttpResponseRedirect,HttpResponse
from django.contrib.auth import logout as auth_logout
from django.contrib.auth.models import User
from forms import LostItemForm,FoundItemForm
from models import LostItem,FoundItem
#######LAT LONG LIST#############
{"Faculty Residency":(28.5439000, 77.2704000,28.5443000, 77.2709000),"Academic Block":(28.5441000, 77.2722000,28.5448000, 77.2729000)}
from django.core.mail import EmailMultiAlternatives,send_mail
class Mail:
	def send_mail(self, message):
		import smtplib
		from email.MIMEMultipart import MIMEMultipart
		from email.MIMEText import MIMEText

<<<<<<< local
=======
		#gmailUser = 'findmystuffiiitd@gmail.com'
		#gmailPassword = 'fuzzynfringe'
		#recipient = 'crete497valet@m.facebook.com'
>>>>>>> other
		gmailUser = 'icpldesk@gmail.com'
		gmailPassword = 'ICPL1@IIITD'
		recipient = 'crete497valet@m.facebook.com'

		msg = MIMEMultipart()
		msg['From'] = gmailUser
		msg['To'] = recipient
		msg['Subject'] = message
		msg.attach(MIMEText(message))

		mailServer = smtplib.SMTP('smtp.gmail.com', 587)
		mailServer.ehlo()
		mailServer.starttls()
		mailServer.ehlo()
		mailServer.login(gmailUser, gmailPassword)
		mailServer.sendmail(gmailUser, recipient, msg.as_string())
		mailServer.close()
###
def home(request):
    """Home view, displays login mechanism"""
    if request.user.is_authenticated():
        return redirect('done')
    return render_to_response('home.html', {}, RequestContext(request))


@login_required
def done(request):
    s=User.objects.get(username=request.user).email
    flag=0
    s1=""
    for i in s:
        if(flag==1):
            s1=s1+i
        if(i=='@'):
         flag=1
            
    #print s1
    if(s1!="iiitd.ac.in"):
        User.objects.get(username=request.user).delete()
        return render_to_response('wronglogin.html', {}, RequestContext(request))
    """Login complete view, displays user data"""
    pre = LostItem.objects.all()
    for ite1 in pre:
	print "preee",ite1
    return redirect('gmap')
                              

def logout(request):
    """Logs out user"""
    auth_logout(request)
    return redirect('home')
    
def lostitem(request):
	if (request.user!=""):
		if request.method == 'POST':
			#print 'in request'
			#print request
			lostitem_form=LostItemForm(request.POST,request.FILES)
			#print 'in request'
			if lostitem_form.is_valid():
				#print 'in request'
				lostitem_form.save()
				####FACEBOOK POST########
				m = Mail()
				s=""
				s=s+"From "+lostitem_form.cleaned_data.get('email')
				s=s+" I have Lost "+lostitem_form.cleaned_data.get('itemname')
				#s=s +"\n"+lostitem_form.cleaned_data.get('additonalinfo')
				s=s+" At "+lostitem_form.cleaned_data.get('location')
				m.send_mail(s)
				print "MAIL SENT"
				return redirect('done')
			return render_to_response('wrongpage.html', {},{})
		else :
			
			s=User.objects.get(username=request.user)
			lostitem_form={'lostitem_form':LostItemForm({'username':request.user,'email':s.email,'firstname':s.first_name,'lastname':s.last_name})}
			return render_to_response('LostItem.html',lostitem_form,RequestContext(request))
	return render_to_response('wrongpage.html', {},{})

def founditem(request):
	if (request.user!=""):
		if request.method == 'POST':
			#print 'in request'
			#print request
			founditem_form=FoundItemForm(request.POST,request.FILES)
			#print 'in request'
			if founditem_form.is_valid():
				#print 'in request'
				founditem_form.save()
				####FACEBOOK POST########
				m = Mail()
				s=""
				s=s+"From "+founditem_form.cleaned_data.get('email')
				s=s+" I have Found "+founditem_form.cleaned_data.get('itemname')
				#s=s +"\n"+founditem_form.cleaned_data.get('additonalinfo')
				s=s+" At "+founditem_form.cleaned_data.get('location')
				m.send_mail(s)
				
				return redirect('done')
			return render_to_response('wrongpage.html', {},{})
		else :
			
			s=User.objects.get(username=request.user)
			founditem_form={'founditem_form':FoundItemForm({'username':request.user,'email':s.email,'firstname':s.first_name,'lastname':s.last_name})}
			return render_to_response('FoundItem.html',founditem_form,RequestContext(request))
	return render_to_response('wrongpage.html', {},{})
	

limit = {"Faculty Residency":(28.5439000, 77.2704000,28.5443000, 77.2709000), "Academic Block":(28.5441000, 77.2722000,28.5448000, 77.2729000), "Library Building":(28.5439000, 77.2722000,28.5440000, 77.2726000), "Student Activity Center":(28.5461649, 77.2731461,28.5462649, 77.2735461), "Boys Hostel":(28.5472649, 77.2734461,28.5475949, 77.2739461), "Girls Hostel":(28.5466649, 77.2732461,28.5468949, 77.2736461), "Sports Field":(28.5474649, 77.2719461,28.5482949, 77.2739461), }
import random
def gmap(request):
	obj=LostItem.objects.all()
	ss = ""
	for i in obj:
		#print i
		#print i.email
		#print i.location	
		if(i.location in limit.keys()):
			x = random.uniform(limit[i.location][0], limit[i.location][2])
			y = random.uniform(limit[i.location][1], limit[i.location][3])
			#x = 28.5460459
		 	#y = 77.2714055
			contentString = ""
			contentString += '<div id="content">'+'<div id="siteNotice">'+'</div>'+'<h1 id="firstHeading" class="firstHeading">'+i.itemname+'</h1>'+ \
		  					'<div id="bodyContent">'+ '<p>'+str(i.additonalinfo)+'</p>'+'(Lost on '+str(i.time)+').</p>'+'<p text-align:right ><a href="/found/'+str(i.id)+'"> \ Report Found</a> '+ '</div>'+ '</div>';
			ss += 'newmarker('+str(x)+','+str(y)+',"'+i.itemname+'",\''+contentString+'\');'
	obj=FoundItem.objects.all()
	
	for i in obj:
		#print i
		#print i.email
		#print i.location	
		if(i.location in limit.keys()):
			x = random.uniform(limit[i.location][0], limit[i.location][2])
			y = random.uniform(limit[i.location][1], limit[i.location][3])
			#x = 28.5460459
		 	#y = 77.2714055
			contentString = ""
			contentString += '<div id="content">'+'<div id="siteNotice">'+'</div>'+'<h1 id="firstHeading" class="firstHeading">'+i.itemname+'</h1>'+ \
		  					'<div id="bodyContent">'+ '<p>'+str(i.additonalinfo)+'</p>'+'(Found on '+str(i.time)+').</p>'+'<p text-align:right ><a href="/lost/'+str(i.id)+'"> \ Report Lost</a> '+ '</div>'+ '</div>';
			ss += 'newmarker('+str(x)+','+str(y)+',"'+i.itemname+'",\''+contentString+'\');'

	s={'s':ss}	
	#s={'s':'newmarker(28.5460459, 77.2714055,"magus",contentString);'+'newmarker(28.5450479, 77.2734055,"kshitij","hello world");'}
	return render_to_response('done.html',s,RequestContext(request))


def found(request,found_id):
	if request.method == 'GET' :
				s="We have found your item. "
				s=s+"Please contact "+str(request.user)
				send_mail(s,LostItem.objects.get(id=found_id).email)
				LostItem.objects.get(id=found_id).delete()
				
				return redirect('gmap')

	return render_to_response('wrongpage.html', {},{})
def lost(request,lost_id):
	if request.method == 'GET' :
				s="The item belongs to"
				s=s+"Please contact "+str(request.user)
				send_mail(s,FoundItem.objects.get(id=lost_id).email)
				#LostItem.objects.get(id=found_id).delete()
				
				return redirect('gmap')

	return render_to_response('wrongpage.html', {},{})
def send_mail(message,to):
		import smtplib
		from email.MIMEMultipart import MIMEMultipart
		from email.MIMEText import MIMEText

		gmailUser = 'icpldesk@gmail.com'
		gmailPassword = 'ICPL1@IIITD'
		recipient = to

		msg = MIMEMultipart()
		msg['From'] = gmailUser
		msg['To'] = recipient
		msg['Subject'] = message
		msg.attach(MIMEText(message))

		mailServer = smtplib.SMTP('smtp.gmail.com', 587)
		mailServer.ehlo()
		mailServer.starttls()
		mailServer.ehlo()
		mailServer.login(gmailUser, gmailPassword)
		mailServer.sendmail(gmailUser, recipient, msg.as_string())
		mailServer.close()


